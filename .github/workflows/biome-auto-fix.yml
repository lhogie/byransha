name: Biome Auto-Fix

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to fix"
        required: true
        default: "main"

jobs:
  auto-fix:
    name: Auto-fix Biome Issues
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request &&
       contains(github.event.comment.body, '/biome-fix') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'))

    steps:
      - name: Get PR details
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            return {
              branch: pr.data.head.ref,
              sha: pr.data.head.sha
            };

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || fromJson(steps.pr.outputs.result).branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install
        working-directory: src/main/java/frontend

      - name: Run Biome auto-fix
        run: |
          echo "ðŸ”§ Running Biome auto-fix..."
          bun run lint:fix
          echo "âœ… Biome auto-fix completed"
        working-directory: src/main/java/frontend

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Biome auto-fix"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected after Biome auto-fix"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ðŸ¤– Auto-fix Biome formatting and linting issues

          - Applied Biome formatting rules
          - Fixed auto-fixable linting issues
          - Generated by GitHub Actions"
          git push

      - name: Comment on PR (success with changes)
        if: github.event_name == 'issue_comment' && steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Biome auto-fix completed successfully!**

              I've automatically fixed the formatting and auto-fixable linting issues in your PR.

              **Changes made:**
              - Applied Biome formatting rules
              - Fixed auto-fixable linting issues

              Please review the changes and run the checks again. You may need to resolve any remaining manual fixes.`
            })

      - name: Comment on PR (success no changes)
        if: github.event_name == 'issue_comment' && steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `â„¹ï¸ **Biome auto-fix completed**

              No auto-fixable issues were found. The remaining issues may require manual intervention.

              Please check the previous Biome reports and fix any remaining issues manually.`
            })

      - name: Comment on PR (failure)
        if: github.event_name == 'issue_comment' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Biome auto-fix failed**

              There was an error running the auto-fix process. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

              You may need to fix the issues manually:
              \`\`\`bash
              cd src/main/java/frontend
              bun run lint:fix
              \`\`\``
            })

      - name: Summary
        run: |
          echo "## ðŸ¤– Biome Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Changes Applied**: Biome auto-fix made changes to your code" >> $GITHUB_STEP_SUMMARY
            echo "- Formatting issues fixed" >> $GITHUB_STEP_SUMMARY
            echo "- Auto-fixable linting issues resolved" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Changes**: No auto-fixable issues found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the changes made by the auto-fix" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`bun run lint\` locally to check for remaining issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix any remaining manual issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Push your final changes" >> $GITHUB_STEP_SUMMARY
